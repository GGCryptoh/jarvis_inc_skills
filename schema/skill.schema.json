{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://jarvis-inc.dev/schemas/skill/v1.0.0/skill.schema.json",
  "title": "Jarvis Inc Skill Definition",
  "description": "JSON Schema for defining skills in the Jarvis Inc Skills Repository. Skills represent capabilities that can be assigned to AI agents.",
  "type": "object",
  "required": ["id", "title", "description", "version", "author", "category", "icon", "connection_type", "commands"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$",
      "description": "Unique skill identifier in kebab-case (e.g. 'read-email', 'generate-code')"
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 60,
      "description": "Human-readable skill title displayed in the UI"
    },
    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Brief description of what the skill does"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version string (e.g. '1.0.0', '2.3.1')"
    },
    "author": {
      "type": "string",
      "minLength": 1,
      "description": "Author name or organization"
    },
    "category": {
      "type": "string",
      "enum": ["communication", "research", "creation", "analysis"],
      "description": "Skill category for grouping in the UI"
    },
    "icon": {
      "type": "string",
      "minLength": 1,
      "description": "Lucide React icon name (e.g. 'Mail', 'Globe', 'Code'). Must be a valid Lucide icon identifier."
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$"
      },
      "uniqueItems": true,
      "description": "Array of lowercase kebab-case tags for search and filtering"
    },
    "status": {
      "type": "string",
      "enum": ["available", "coming_soon", "beta", "deprecated"],
      "default": "available",
      "description": "Current availability status of the skill"
    },
    "connection_type": {
      "type": "string",
      "enum": ["llm", "oauth", "api_key", "cli", "none"],
      "description": "How the skill connects to its underlying service. 'llm' = uses an AI model, 'oauth' = OAuth 2.0 flow, 'api_key' = API key authentication, 'cli' = command-line tool, 'none' = no external connection"
    },
    "models": {
      "type": ["array", "null"],
      "items": {
        "type": "string"
      },
      "description": "Available LLM models for this skill. Required when connection_type is 'llm', null otherwise."
    },
    "default_model": {
      "type": ["string", "null"],
      "description": "Default model to use. Required when connection_type is 'llm', null otherwise."
    },
    "fixed_service": {
      "type": ["string", "null"],
      "description": "Name of the fixed external service (e.g. 'Google', 'Slack', 'OpenAI'). Used when service_type is 'fixed'."
    },
    "service_type": {
      "type": ["string", "null"],
      "enum": ["fixed", "configurable", null],
      "description": "'fixed' = hardcoded to one service, 'configurable' = user can choose provider, null = not applicable"
    },
    "oauth_config": {
      "type": ["object", "null"],
      "description": "OAuth 2.0 configuration. Required when connection_type is 'oauth'.",
      "properties": {
        "provider": {
          "type": "string",
          "description": "OAuth provider identifier (e.g. 'google', 'slack', 'github')"
        },
        "auth_url": {
          "type": "string",
          "format": "uri",
          "description": "Authorization endpoint URL"
        },
        "token_url": {
          "type": "string",
          "format": "uri",
          "description": "Token exchange endpoint URL"
        },
        "scopes": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Required OAuth scopes"
        },
        "pkce": {
          "type": "boolean",
          "default": false,
          "description": "Whether to use PKCE (Proof Key for Code Exchange) in the OAuth flow"
        }
      },
      "required": ["provider", "auth_url", "token_url", "scopes"]
    },
    "curl_example": {
      "type": ["string", "null"],
      "description": "Example cURL command demonstrating the underlying API call. Useful for api_key connection types."
    },
    "cli_config": {
      "type": ["object", "null"],
      "description": "CLI tool configuration. Required when connection_type is 'cli'.",
      "properties": {
        "binary": {
          "type": "string",
          "description": "CLI binary name or path"
        },
        "install_command": {
          "type": "string",
          "description": "Command to install the CLI tool"
        },
        "version_check": {
          "type": "string",
          "description": "Command to check installed version"
        }
      },
      "required": ["binary"]
    },
    "api_config": {
      "type": ["object", "null"],
      "description": "API configuration for api_key connection types. Describes the external API endpoint.",
      "properties": {
        "base_url": {
          "type": "string",
          "description": "Base URL for API requests. Can be empty string when the full URL is constructed dynamically (e.g. fetch-webpage-markdown)."
        },
        "auth_header": {
          "type": "string",
          "default": "Authorization",
          "description": "Header name for the API key (e.g. 'Authorization', 'X-API-Key')"
        },
        "auth_prefix": {
          "type": "string",
          "default": "Bearer",
          "description": "Prefix before the key value (e.g. 'Bearer', 'Api-Key')"
        },
        "vault_service": {
          "type": "string",
          "description": "Vault service name to look up the API key (e.g. 'openai', 'stability')"
        },
        "api_model": {
          "type": "string",
          "description": "Model ID to use in API calls (e.g. 'dall-e-3', 'gemini-2.5-flash-image'). This is the source of truth â€” executors must read from here, never hardcode."
        },
        "headers": {
          "type": "object",
          "additionalProperties": { "type": "string" },
          "description": "Custom HTTP headers to include in every request (e.g. { \"Accept\": \"text/markdown\" }). Merged with auth headers. Skill-defined headers take precedence over defaults."
        },
        "auth_in_query": {
          "type": ["string", "null"],
          "description": "Query param name for API key (e.g. 'key'). When set, key goes in URL query string instead of Authorization header. Used by APIs like Gemini that use ?key=xxx."
        }
      },
      "required": ["base_url", "vault_service"]
    },
    "output_type": {
      "type": "string",
      "enum": ["text", "image", "audio", "data", "mixed"],
      "default": "text",
      "description": "Primary output type of this skill. Determines how results are rendered in chat, collateral, and test dialogs. 'image' = base64/URL images, 'audio' = audio files, 'data' = structured JSON, 'mixed' = multiple types."
    },
    "collateral": {
      "type": "boolean",
      "default": true,
      "description": "Whether skill execution results should be automatically saved to the Collateral page as artifacts."
    },
    "execution_handler": {
      "type": ["string", "null"],
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "DEPRECATED: Prefer declarative request/response blocks in commands. Kept as fallback for complex multi-step integrations that can't be expressed declaratively. Named execution handler function in skillExecutor.ts."
    },
    "permissions": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["network", "filesystem_read", "filesystem_write", "shell_exec", "sudo", "docker_exec"]
      },
      "description": "Required permissions. 'shell_exec' and above trigger danger warnings in UI. Skills running in Docker sidecar are sandboxed."
    },
    "risk_level": {
      "type": "string",
      "enum": ["safe", "moderate", "dangerous"],
      "default": "safe",
      "description": "Risk classification for skill enablement. 'safe' = normal approval flow. 'moderate' = yellow warning banner on approval card. 'dangerous' = red warning + type-to-confirm gate before enabling. CLI skills default to 'moderate', bash/shell/sudo skills should be 'dangerous'."
    },
    "handler_runtime": {
      "type": ["string", "null"],
      "enum": ["typescript", "python", "bash", null],
      "default": null,
      "description": "Runtime for handler files. null = declarative-only (no code). 'typescript' = Node.js dynamic import, 'python' = child_process with JSON stdin/stdout, 'bash' = child_process with env vars."
    },
    "files": {
      "type": ["array", "null"],
      "items": { "type": "string" },
      "description": "List of files in the skill package directory (relative to skill dir). Used by installer to download all files. e.g. ['handlers/query.ts', 'handlers/generate.ts', 'scripts/process.py']"
    },
    "default_schedule": {
      "type": "object",
      "description": "Default schedule for automatic execution. Users can override.",
      "properties": {
        "frequency": { "type": "string", "enum": ["daily", "weekly", "monthly"] },
        "run_at_time": { "type": "string", "pattern": "^\\d{2}:\\d{2}$", "description": "HH:MM in local time" },
        "run_on_day": { "type": "integer", "description": "Day of week (0=Sun) for weekly, day of month for monthly" },
        "command": { "type": "string", "description": "Command name to execute" },
        "params": { "type": "object", "description": "Parameters to pass to the command" }
      },
      "required": ["frequency", "command"]
    },
    "pricing": {
      "type": "object",
      "description": "Cost model for this skill's API usage",
      "properties": {
        "model": { "type": "string", "enum": ["free", "per_request", "per_token"] },
        "base_cost_usd": { "type": "number" },
        "tiers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "when": { "type": "object" },
              "cost_usd": { "type": "number" }
            }
          }
        }
      }
    },
    "commands": {
      "type": "array",
      "minItems": 1,
      "description": "Array of command definitions that this skill exposes",
      "items": {
        "type": "object",
        "required": ["name", "description", "parameters"],
        "properties": {
          "name": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_]*$",
            "description": "Command identifier in snake_case"
          },
          "description": {
            "type": "string",
            "minLength": 5,
            "description": "What this command does"
          },
          "parameters": {
            "type": "array",
            "description": "Array of parameter definitions for this command",
            "items": {
              "type": "object",
              "required": ["name", "type", "required", "description"],
              "additionalProperties": false,
              "properties": {
                "name": {
                  "type": "string",
                  "pattern": "^[a-z][a-z0-9_]*$",
                  "description": "Parameter name in snake_case"
                },
                "type": {
                  "type": "string",
                  "enum": ["string", "number", "boolean", "array", "object"],
                  "description": "Parameter data type"
                },
                "required": {
                  "type": "boolean",
                  "description": "Whether this parameter is required"
                },
                "description": {
                  "type": "string",
                  "description": "Human-readable parameter description"
                },
                "default": {
                  "description": "Default value if parameter is optional"
                },
                "enum": {
                  "type": "array",
                  "description": "Allowed values for this parameter"
                }
              }
            }
          },
          "returns": {
            "type": "object",
            "required": ["type", "description"],
            "additionalProperties": false,
            "properties": {
              "type": {
                "type": "string",
                "enum": ["string", "text", "number", "boolean", "array", "object"],
                "description": "Return data type. 'text' is an alias for 'string' used by some skills."
              },
              "description": {
                "type": "string",
                "description": "Description of the return value"
              },
              "media_type": {
                "type": "string",
                "description": "MIME type of the returned content (e.g. 'image/png', 'audio/mp3', 'application/json'). Used by UI to render results correctly."
              }
            }
          },
          "system_prompt": {
            "type": "string",
            "description": "System prompt for LLM execution. Overrides the default generic system prompt. Supports {param} interpolation."
          },
          "prompt_template": {
            "type": "string",
            "description": "User message template for LLM execution. Supports {param} interpolation from command parameters."
          },
          "request": {
            "type": "object",
            "description": "Declarative HTTP request config. When present, the generic executor handles this command instead of a hardcoded handler.",
            "properties": {
              "method": { "type": "string", "enum": ["GET", "POST", "PUT", "DELETE"], "default": "GET" },
              "path": { "type": "string", "description": "Appended to api_config.base_url. Supports {param_name} interpolation. Special: {api_model}, {api_key}." },
              "query": { "type": "object", "additionalProperties": { "type": "string" }, "description": "Static + interpolated query params" },
              "headers": { "type": "object", "additionalProperties": { "type": "string" }, "description": "Additional HTTP headers for this command" },
              "body": { "description": "JSON body template. String values with {param} get interpolated. Null for GET." },
              "response_format": { "type": "string", "enum": ["json", "text", "binary"], "default": "json", "description": "Expected response format. 'text' calls resp.text(), 'binary' calls resp.arrayBuffer(), 'json' (default) calls resp.json()." },
              "proxy": { "type": "boolean", "default": false, "description": "Route through gateway CORS proxy (/api/fetch-proxy). Required for browser-side fetches to arbitrary domains." }
            },
            "required": ["method", "path"]
          },
          "response": {
            "type": "object",
            "description": "How to parse the API response.",
            "properties": {
              "passthrough": { "type": "boolean", "default": false, "description": "Skip extraction, return raw response as-is" },
              "passthrough_to_llm": { "type": "boolean", "default": false, "description": "Send raw response to LLM for formatting (requires passthrough:true)" },
              "extract": { "type": "object", "additionalProperties": { "type": "string" }, "description": "Named fields to extract via dot-path (e.g. 'current_condition[0].temp_F')" },
              "extract_raw": { "type": "string", "description": "Single dot-path for the entire result (e.g. binary data)" },
              "error_path": { "type": "string", "description": "Dot-path to check for API error message" },
              "image_field": { "type": "string", "description": "Dot-path to base64 image data in response. Auto-uploads to Supabase Storage and sets {image_url} template variable." }
            }
          },
          "output_template": {
            "type": "string",
            "description": "Markdown template with {field} placeholders from response.extract"
          },
          "post_processors": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type"],
              "properties": {
                "type": { "type": "string", "description": "Handler name: upload_image, estimate_cost" },
                "config": { "type": "object", "description": "Handler-specific configuration" }
              }
            }
          },
          "multi_request": {
            "type": "object",
            "description": "Fan-out pattern: execute the same request template multiple times with different values. Results merged per merge_strategy.",
            "properties": {
              "iterate_over": { "type": "array", "items": { "type": "string" }, "description": "Array of values to iterate over" },
              "iterate_param": { "type": "string", "description": "Parameter name to substitute with each iteration value" },
              "merge_strategy": { "type": "string", "enum": ["concat", "object", "array"], "default": "concat", "description": "'concat' = merge text outputs, 'object' = merge into keyed object, 'array' = collect into array" }
            },
            "required": ["iterate_over", "iterate_param"]
          },
          "cli_command_template": {
            "type": "object",
            "description": "Declarative execution template for CLI/HTTP skills. For direct HTTP: set url_template + method. For gateway-executed commands: set gateway_exec + command_template.",
            "properties": {
              "url_template": { "type": "string", "description": "URL template with {param} interpolation (e.g. 'https://wttr.in/{location}?format=j1')" },
              "method": { "type": "string", "enum": ["GET", "POST", "PUT", "DELETE"], "default": "GET" },
              "headers": { "type": "object", "additionalProperties": { "type": "string" } },
              "response_type": { "type": "string", "enum": ["json", "text"], "default": "json" },
              "gateway_exec": { "type": "boolean", "default": false, "description": "Route through gateway /exec-cli endpoint for actual shell execution" },
              "command_template": { "type": "string", "description": "Shell command template with {param} interpolation. Only used when gateway_exec is true." },
              "timeout": { "type": "number", "default": 30, "description": "Execution timeout in seconds" }
            }
          },
          "handler_file": {
            "type": ["string", "null"],
            "description": "Path to handler file relative to skill directory (e.g. 'handlers/query.ts'). When present, gateway executes this file instead of declarative request or hardcoded handler."
          }
        }
      }
    }
  },
  "if": {
    "properties": { "connection_type": { "const": "llm" } }
  },
  "then": {
    "properties": {
      "models": { "type": "array", "minItems": 1 },
      "default_model": { "type": "string", "minLength": 1 }
    },
    "required": ["models", "default_model"]
  },
  "else": {
    "if": {
      "properties": { "connection_type": { "const": "oauth" } }
    },
    "then": {
      "required": ["oauth_config"],
      "properties": {
        "oauth_config": { "type": "object" }
      }
    }
  }
}
